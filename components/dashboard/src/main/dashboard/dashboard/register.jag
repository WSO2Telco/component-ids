<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mobile Connect</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <!-- styles -->
  
  <script src="/portal/gadgets/user_profile/js/jquery.min.js" type="text/javascript"></script>
  <script src="/portal/gadgets/user_profile/js/main.js" type="text/javascript"></script>
  <script src="/portal/gadgets/user_profile/js/modal.js" type="text/javascript"></script>
  <script src="/dashboard/js/landing.js" type="text/javascript"></script>
  
  <link rel="stylesheet" href="mcresources/css/style.css">

  <!-- load main script early asyncronously -->
  <script type="text/javascript" src="/dashboard/mcresources/js/main.js" ></script>

  <noscript>
    <!-- Fallback synchronous download, halt page rendering if load is slow  -->
    <link href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic,300italic,700italic" rel="stylesheet" type="text/css">
  </noscript>
  <!-- loads fonts asyncronously preventing font loading from block page render -->
  <script>
    // Config for loading the web fonts
    var WebFontConfig = {
      google: {
        families: ['Roboto:400,300,700,400italic,300italic,700italic']
      },
      active: function() {
        // Set a cookie that the font has been downloaded and should be cached
        var d = new Date();
        d.setTime(d.getTime() + (7 * 86400000)); // plus 7 Days
        document.cookie = "cachedroboto=true; expires=" + d.toGMTString() + "; path=/";
      }
    };
    </script>
    <script src="mcresources/js/vendor/webfontloader.js"></script>
    
    <script type="text/javascript" src="mcresources/js/vendor/modernizr.js"></script>

    <%
    var log = new Log();
    
    var token = request.getParameter("token")!= null ?  request.getParameter("token") : "";

    log.info( "tokenid :"+token );
    var acr = request.getParameter("acr")!= null ?  request.getParameter("acr") : "";
    log.info( "acr value from login and reading LOA:"+acr );
    
    var operator = request.getParameter("operator")!= null ?  request.getParameter("operator") : "";
    log.info( "operator :"+operator );

    var serverDetails = require("site/jagg/site.jag");
    var strBackend = serverDetails.getWebAppsUrl() +"UserRegistration-1.0-SNAPSHOT/webresources/endpoint/user/authenticate/get?tokenid=" + token;
    log.info(strBackend);
    var xhr = new XMLHttpRequest();
    xhr.open("GET", strBackend, false);
    xhr.send();


    var result = parse(xhr.responseText.toString());
    log.info("get msisdn from token"+result.msisdn);
    var msisdn=result.msisdn;

    if(operator != ""){
      %>
      <link href="css/branding/<%=operator%>-style.css" rel="stylesheet">
      <%}%>
    </head>


    <body>

      <body class="theme--light">
        <div class="site__root">
          <header class="site-header">
            <div class="site-header__inner site__wrap">
              <h1 class="visuallyhidden">Mobile&nbsp;Connect</h1>
              <a href="/"><img src="mcresources/img/svg/mobile-connect.svg" alt="Mobile Connect&nbsp;Logo" width="150" class="site-header__logo"></a>
               <% if(operator != ""){ 
            var imgPath = "img/branding/" + operator + "_logo.svg";
          %>
            <p class="site-header__powered-by">powered&nbsp;by      
            </p>
            <a >
            <img class="brandLogo" src='<%= imgPath %>' alt='<%= operator %>' >
            </a>
          <% } %>

            </div>
          </header>

          <main class="site__main site__wrap section v-distribute v-grow">
            <div class="slider slider--all slick v-grow">
              <section class="slider__slide">
                <div class="slider__slide-inner v-distribute">
                  <header class="page__header">
                    <h1 class="page__heading">Secure</h1>
                    <p>A safer, more secure way to&nbsp;log-in.</p>
                    <a href="https://mobileconnect.io/" class="cta">Learn&nbsp;more</a>
                  </header>
                  <div class="page__illustration v-grow v-align-content">
                    <div>
                      <img src="mcresources/img/svg/secure.svg" alt="Secure" width="106" height="126">
                    </div>
                  </div>
                </div>
              </section>

              <section class="slider__slide">
                <div class="slider__slide-inner v-distribute">
                  <header class="page__header">
                    <h1 class="page__heading">Private</h1>
                    <p>Your personal data is never shared without your&nbsp;permission.</p>
                    <a href="https://mobileconnect.io/" class="cta">Learn&nbsp;more</a>
                  </header>
                  <div class="page__illustration v-grow v-align-content">
                    <div>
                      <img src="mcresources/img/svg/private.svg" alt="Private" width="160" height="107">
                    </div>
                  </div>
                </div>
              </section>

              <section class="slider__slide">
                <div class="slider__slide-inner v-distribute">
                  <header class="page__header">
                    <h1 class="page__heading">Convenient</h1>
                    <p>No need for multiple passwords or&nbsp;usernames.</p>
                    <a href="https://mobileconnect.io/" class="cta">Learn&nbsp;more</a>
                  </header>
                  <div class="page__illustration v-grow v-align-content">
                    <div>
                      <img src="mcresources/img/svg/convenient.svg" alt="Convenient" width="106" height="127">
                    </div>
                  </div>
                </div>
              </section>
            </div>
            <div class="page__copy">
              <p>
                Looks like you don't yet have an account. Want to set one up? It's quick and&nbsp;easy.
              </p>
            </div>


            <form  class="form-horizontal" id="selfReg" name="selfReg">

              <input type="hidden" name="regExp_PRIMARY" value="^[\S]{5,30}$">

              <div class="control-group">
                <div class="controls" style="display:none;" type="hidden">
                  <select name="domain">

                    <option value="PRIMARY">PRIMARY</option>

                  </select>
                </div>
              </div>

              <input type="hidden" value="" id="user_name" name="userName">
              <input type="hidden" value="" id="password" name="pwd">
              <input type="hidden" value="" id="retype_pwd" name="retypePwd">
              <input type="hidden"  value='<%=operator%>' name="operator" id="operator"/>
              <input type="hidden"  value='<%=token%>' name="token" id="token"/>
              <input type="hidden"  value='<%=acr%>' name="acr" id="acr"/>

              <input type="hidden"  value='<%=acr%>' name="http://wso2.org/claims/acr" id="Acr"/>
              <input type="hidden" value="<%=msisdn%>" id="Mobile" name="http://wso2.org/claims/mobile">
                <!-- <input type="hidden" value="<%=msisdn%>" id="msisdn" name="msisdn">
              -->

              <ul class="form-fields" >
                <li class="size--medium" id ="LoA2" style="display:none" >
                  <p align="center">By setting up an account, you are agreeing to the <a href="https://identity.demo.wso2telco.com/dashboard/termsConditions.html" target="_blank">Terms and Conditions</a></p>
                  <p align="center">The <a href="/no-page" target="_blank">Mobile Connect Privacy Promise</a> means that your mobile number wonâ€™t be shared and no personal information will be disclosed without your consent. See our full <a href="/no-page" target="_blank">privacy policy&nbsp;here</a>.</p>
                </li>
                <li></li>

                <li>
                  <div class="grid">
                    <div class="grid__item one-half">
                      <a onclick="cancelProcessToLogin()" class="btn btn--outline btn--full btn--large" data-dismiss="modal">
                        No&nbsp;thanks
                      </a>
                    </div>
                    <div class="grid__item one-half">
                      <button type="button" id="validate-btn" name="action" onclick="flow()" value="yes" class="btn btn--full btn--fill btn--large btn--color">
                        Yes
                      </button>
                    </div>
                  </div>
                </li>
              </ul>
            </form>

            <!-- Modal -->

          </main>
        </div>

        <script type="text/javascript">

        var acr=getAcrValue();
         // alert(acr);
         var e1 = document.getElementById("LoA2");
         var acrval = document.getElementById("acr");
         acrval.value=acr;

         if(acr=="USSDPinAuthenticator"){
          e1.style.display = 'none';
        }
        if(acr=="USSDAuthenticator"){
          e1.style.display = 'block';
        }

        function flow(){
          if(acr=="USSDAuthenticator"){

            validate();
          }else{
            window.location.href="registerLoA3.jag?msisdn=<%=msisdn%>&token=<%=token%>&acr="+acr+"&operator="+'<%=operator%>';
          }
        }

        </script>


      </body>

      </html>
